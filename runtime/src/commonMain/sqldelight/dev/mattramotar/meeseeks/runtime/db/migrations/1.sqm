PRAGMA foreign_keys=OFF;

CREATE TABLE taskSpec_new (
    id TEXT NOT NULL PRIMARY KEY,

    -- State and Metadata
    state TEXT NOT NULL,
    created_at_ms INTEGER NOT NULL,
    updated_at_ms INTEGER NOT NULL,
    run_attempt_count INTEGER NOT NULL DEFAULT 0,
    platform_id TEXT,

    -- Payload
    payload_type_id TEXT NOT NULL,
    payload_data TEXT NOT NULL,

    -- Priority
    priority INTEGER NOT NULL,

    -- Constraints
    requires_network INTEGER NOT NULL DEFAULT 0,
    requires_charging INTEGER NOT NULL DEFAULT 0,
    requires_battery_not_low INTEGER NOT NULL DEFAULT 0,

    -- Schedule
    schedule_type TEXT NOT NULL,
    next_run_time_ms INTEGER NOT NULL,
    initial_delay_ms INTEGER NOT NULL,
    interval_duration_ms INTEGER NOT NULL,
    flex_duration_ms INTEGER NOT NULL,

    -- Retry Policy
    backoff_policy TEXT NOT NULL,
    backoff_delay_ms INTEGER NOT NULL,
    max_retries INTEGER NOT NULL,
    backoff_multiplier REAL
);

INSERT INTO taskSpec_new(
    id, state, created_at_ms, updated_at_ms, run_attempt_count, platform_id,
    payload_type_id, payload_data, priority,
    requires_network, requires_charging, requires_battery_not_low,
    schedule_type, next_run_time_ms, initial_delay_ms, interval_duration_ms, flex_duration_ms,
    backoff_policy, backoff_delay_ms, max_retries, backoff_multiplier
)
SELECT
    CAST(id AS TEXT), state, created_at_ms, updated_at_ms, run_attempt_count, platform_id,
    payload_type_id, payload_data, priority,
    requires_network, requires_charging, requires_battery_not_low,
    schedule_type, next_run_time_ms, initial_delay_ms, interval_duration_ms, flex_duration_ms,
    backoff_policy, backoff_delay_ms, max_retries, backoff_multiplier
FROM taskSpec;

DROP TABLE taskSpec;
ALTER TABLE taskSpec_new RENAME TO taskSpec;

CREATE TABLE taskLogEntity_new (
    id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    taskId TEXT NOT NULL,
    created INTEGER NOT NULL,
    result TEXT NOT NULL,
    attempt INTEGER NOT NULL,
    message TEXT,
    FOREIGN KEY (taskId) REFERENCES taskSpec(id)
);

INSERT INTO taskLogEntity_new (id, taskId, created, result, attempt, message)
SELECT id, CAST(taskId AS TEXT), created, result, attempt, message
FROM taskLogEntity;

DROP TABLE taskLogEntity;
ALTER TABLE taskLogEntity_new RENAME TO taskLogEntity;

CREATE INDEX idx_taskSpec_scheduler ON taskSpec (state, next_run_time_ms ASC, priority DESC);
CREATE INDEX idx_taskSpec_platform_id ON taskSpec (platform_id);

PRAGMA foreign_keys=ON;
